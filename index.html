<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Supplier Email Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Manrope', sans-serif; background: #f8fafc; color: #222; margin: 0; padding: 24px; }
    h1 { margin-bottom: 12px; color: #09b367; text-align: center; }
    .cards { display: flex; justify-content: center; margin-top: 40px; }
    .card {
      background: white;
      border-radius: 14px;
      padding: 40px 60px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
    }
    .card:hover { transform: scale(1.03); box-shadow: 0 6px 14px rgba(0,0,0,0.12); }
    .count { font-size: 50px; font-weight: 700; color: #09b367; margin-bottom: 6px; }
    .label { font-size: 18px; color: #555; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f1f1f1; }
    button {
      background: #09b367;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #078c58; }
    #backBtn {
      margin-bottom: 16px;
      background: #ccc;
      color: #222;
    }
  </style>
</head>
<body>
  <h1>Supplier Email Dashboard</h1>

  <!-- Summary Page -->
  <div id="summary-page">
    <div class="cards">
      <div class="card" onclick="showDetails()">
        <div class="count" id="total">0</div>
        <div class="label">Total Open</div>
      </div>
    </div>
  </div>

  <!-- Details Page -->
  <div id="details-page" style="display:none;">
    <button id="backBtn" onclick="backToSummary()">‚Üê Back</button>
    <div id="table-container"></div>
  </div>

  <script>
    // Refresh every 5 minutes
    setInterval(() => location.reload(), 5 * 60 * 1000);

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLiqTx5i_HBFszRofx4ItO9IZPTGNJxN87iAK4ckHSyFMfFeN1F56M7RQ17LBLBZdqZHmB8UXck4GE/pub?gid=307971943&single=true&output=csv";
    const FORM_RESPONSES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLiqTx5i_HBFszRofx4ItO9IZPTGNJxN87iAK4ckHSyFMfFeN1F56M7RQ17LBLBZdqZHmB8UXck4GE/pub?gid=559400576&single=true&output=csv"; // üîπ Replace this with your Form Responses CSV URL

    const EXCLUDED_REPLYTO = [
      "GetYourGuide <do-not-reply@notification.getyourguide.com>",
      "Viator <no-reply@m1.viator.com>"
    ];

    // CSV parser that handles quotes and commas
    function parseCSV(text) {
      const rows = [];
      let row = [], value = '', inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i], next = text[i + 1];
        if (char === '"' && inQuotes && next === '"') { value += '"'; i++; }
        else if (char === '"') { inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { row.push(value); value = ''; }
        else if ((char === '\n' || char === '\r') && !inQuotes) {
          if (value || row.length) { row.push(value); rows.push(row); row = []; value = ''; }
        } else value += char;
      }
      if (value || row.length) row.push(value), rows.push(row);
      return rows;
    }

    async function fetchCSVData(url) {
      const res = await fetch(url);
      const text = await res.text();
      const rows = parseCSV(text);
      const headers = rows[0].map(h => h.trim());
      return rows.slice(1).map(r => Object.fromEntries(headers.map((h, i) => [h, r[i] ? r[i].trim() : ''])));
    }

    async function loadDashboard() {
      const [emailData, formData] = await Promise.all([
        fetchCSVData(SHEET_URL),
        fetchCSVData(FORM_RESPONSES_URL)
      ]);

    const closedMsgIds = new Set(
      formData
        .map(r => (r.msgID || "").trim())
        .filter(id => id !== "")
    );


      // Filter rules
      const filtered = emailData.filter(r => {
        const replyto = (r.replyto || "").trim();
        const status = (r.status2 || "").toLowerCase();
        const msgId = (r.msgId || "").trim();

        const excludedReply = EXCLUDED_REPLYTO.some(x => replyto.includes(x));
        const isClosed = status === "closed";
        const alreadyClosedViaForm = closedMsgIds.has(msgId);

        return !excludedReply && !isClosed && !alreadyClosedViaForm;
      });

      document.getElementById("total").textContent = filtered.length;
      window.filteredData = filtered; // store globally
    }

    function showDetails() {
      document.getElementById("summary-page").style.display = "none";
      document.getElementById("details-page").style.display = "block";
      renderTable(window.filteredData || []);
    }

    function backToSummary() {
      document.getElementById("details-page").style.display = "none";
      document.getElementById("summary-page").style.display = "block";
    }

    function renderTable(data) {
      const container = document.getElementById("table-container");
      if (data.length === 0) {
        container.innerHTML = "<p>No open emails üéâ</p>";
        return;
      }

      let html = "<table><tr><th>Msg ID</th><th>From</th><th>Subject</th><th>Date</th><th>Action</th></tr>";
      data.forEach(d => {
        html += `<tr>
          <td>${d.msgId || '-'}</td>
          <td>${d.from || '-'}</td>
          <td>${d.subject || '-'}</td>
          <td>${d.date || '-'}</td>
          <td><a href="https://forms.gle/vQj6t24KsFKLsAHq8?usp=pp_url&entry.msgId=${d.msgId}" target="_blank"><button>Close</button></a></td>
        </tr>`;
      });
      html += "</table>";
      container.innerHTML = html;
    }

    loadDashboard();
    setInterval(() => {
      const event = new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: true
      });
      document.body.dispatchEvent(event);
    }, 5 * 60 * 1000);
  </script>
</body>
</html>




